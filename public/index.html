<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Green Zone Vehicle Access Permit - Apply - Municipal Services</title>
  <link rel="stylesheet" href="/css/gov.css">
  <!-- Favicon: simple blue square to look official -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%23003078'/><text x='50%25' y='55%25' text-anchor='middle' dominant-baseline='middle' fill='white' font-size='14' font-family='sans-serif' font-weight='bold'>GN</text></svg>">
  <style>
    /* Page-specific overrides */
    .loading-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 400px;
      flex-direction: column;
      gap: 20px;
      color: var(--gov-grey-3);
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--gov-grey-1);
      border-top-color: var(--gov-blue);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <!-- ============================================================
       GOVERNMENT HEADER
       ============================================================ -->
  <header class="gov-header" role="banner">
    <div class="gov-header__container">
      <a href="/" class="gov-header__logo">
        <!-- Crown SVG (simplified) -->
        <svg class="gov-header__logo-crown" viewBox="0 0 132 97" xmlns="http://www.w3.org/2000/svg">
          <path d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.2-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm112-28.2c-3.5 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.9-9.1 3.6-1.5 7.6.2 9.1 3.8 1.4 3.6-.3 7.5-3.9 9zm0 20c-3.5 1.5-7.7-.2-9.1-3.8-1.5-3.6.2-7.7 3.9-9.1 3.5-1.5 7.6.3 9.1 3.8 1.4 3.6-.3 7.6-3.9 9.1zm-16 8c-3.5 1.5-7.7-.2-9.1-3.8-1.5-3.6.2-7.7 3.9-9.1 3.5-1.5 7.6.3 9.1 3.8 1.4 3.5-.3 7.5-3.9 9zM66 92.8c16.9 0 32.8-1.1 47.1-3.2 4.3-.7 7.3-4.7 6.6-9.1-.7-4.2-4.7-7.2-9-6.5-12.7 1.9-27 3-42.7 3s-29.9-1.1-42.5-3c-4.3-.7-8.3 2.3-9 6.5-.7 4.4 2.3 8.4 6.6 9.1 14.2 2.1 30.1 3.2 47 3.2h-.1zM66 0L22 36.1c-2 1.8-2.4 4.8-1 7.2.4.7.9 1.3 1.6 1.7L66 88l43.4-43c.7-.4 1.2-1 1.6-1.7 1.4-2.4 1-5.4-1-7.2L66 0z" fill="currentColor"/>
        </svg>
        <span class="gov-header__logotype">GOV.NEWLAND</span>
      </a>
      <span class="gov-header__service-name">Municipal Services</span>
    </div>
  </header>

  <!-- ============================================================
       PHASE BANNER (adds realism)
       ============================================================ -->
  <div class="gov-phase-banner">
    <div class="gov-phase-banner__container">
      <span class="gov-phase-banner__tag">Online</span>
      This is an online government service.
    </div>
  </div>

  <!-- ============================================================
       SECTION STEPPER (built dynamically by engine.js)
       ============================================================ -->
  <div id="stepper-container"></div>

  <!-- ============================================================
       MAIN CONTENT AREA (pages render here)
       ============================================================ -->
  <main class="gov-main" id="main-content" role="main">
    <div id="page-container">
      <div class="loading-screen">
        <div class="loading-spinner"></div>
        <p>Loading service...</p>
      </div>
    </div>
  </main>

  <!-- ============================================================
       FOOTER
       ============================================================ -->
  <footer class="gov-footer" role="contentinfo">
    <div class="gov-footer__container">
      <ul class="gov-footer__links">
        <li><a href="#" onclick="return false;">Accessibility</a></li>
        <li><a href="#" onclick="return false;">Privacy notice</a></li>
        <li><a href="#" onclick="return false;">Cookies</a></li>
        <li><a href="#" onclick="return false;">Contact</a></li>
      </ul>
      <div class="gov-footer__meta">
        <span class="gov-footer__copyright">
          &copy; Crown copyright. Government of Newland. All content available under the 
          <a href="#" onclick="return false;" class="gov-link">Open Government Licence v3.0</a>.
        </span>
      </div>
    </div>
  </footer>

  <!-- ============================================================
       SCRIPTS
       ============================================================ -->
  <script src="/js/tracker.js"></script>
  <script src="/js/engine.js"></script>
  <script src="/js/procedure_greenzone.js"></script>
  
  <script>
    /**
     * Application initialization
     *
     * 1. Creates tracker and initializes session (with resume support)
     * 2. Handles already-completed sessions (duplicate prevention)
     * 3. Loads procedure config and starts engine (restoring state if resuming)
     */
    (async function() {
      const tracker = new SludgeTracker({
        apiBase: '',
        flushInterval: 10000,
      });

      const result = await tracker.initSession();

      if (!result) {
        document.getElementById('page-container').innerHTML = `
          <div class="gov-main__two-thirds">
            <h1 class="gov-heading-l">Service temporarily unavailable</h1>
            <p class="gov-body">We're sorry, the service is experiencing technical difficulties. Please try again later.</p>
          </div>
        `;
        return;
      }

      // Duplicate participation: already completed this study
      if (result.already_complete) {
        document.getElementById('stepper-container').style.display = 'none';
        document.getElementById('page-container').innerHTML = `
          <div class="gov-main__two-thirds" style="margin-top: 30px;">
            <h1 class="gov-heading-l">Study already completed</h1>
            <p class="gov-body">Our records show that you have already completed this study. Each participant may only complete the study once.</p>
            <p class="gov-body">If you believe this is an error, please contact the research team.</p>
            <a href="${GREENZONE_PROCEDURE.prolificCompletionUrl || '#'}" class="gov-button" role="button">Return to Prolific</a>
          </div>
        `;
        return;
      }

      // Select procedure
      const procedure = GREENZONE_PROCEDURE;

      // Create engine with optional resume state
      const engine = new ProcedureEngine(procedure, tracker, result.resumeState || null);
      engine.start();
    })();
  </script>

</body>
</html>
